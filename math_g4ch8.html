<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸å‹‡è€…ï¼šå››å‰‡é‹ç®—å¤§æŒ‘æˆ° V3.0 (é›™é—œå¡)</title>
    <style>
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .game-container {
            background-color: #34495e;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            width: 90%;
            max-width: 600px;
            border: 4px solid #f1c40f;
            position: relative; 
            z-index: 1;
        }

        h1 { margin-top: 0; color: #f1c40f; text-shadow: 2px 2px #000; }

        /* æˆ°é¬¥å€ */
        .battle-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin: 20px 0;
            height: 150px;
        }

        .character {
            font-size: 80px;
            transition: transform 0.2s;
            cursor: default;
        }

        .hp-bar-container {
            width: 100%;
            height: 20px;
            background-color: #555;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .hp-bar {
            height: 100%;
            transition: width 0.5s ease-out;
        }

        #monster-hp-bar { background-color: #e74c3c; width: 100%; }
        #hero-hp-bar { background-color: #2ecc71; width: 100%; }

        /* é¡Œç›®å€ */
        .question-box {
            background-color: #ecf0f1;
            color: #2c3e50;
            font-size: 32px;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 3px dashed #bdc3c7;
        }
        
        /* è®“æ‹¬è™Ÿé¡Œç›®æ›´æ˜é¡¯ */
        .question-box span.paren { color: #e74c3c; }

        /* è¼¸å…¥å€ */
        input[type="number"] {
            font-size: 24px;
            padding: 10px;
            width: 120px;
            text-align: center;
            border-radius: 5px;
            border: none;
        }

        button {
            font-size: 24px;
            padding: 10px 25px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            box-shadow: 0 5px #2980b9;
            margin-left: 10px;
        }
        button:active { box-shadow: 0 2px #2980b9; transform: translateY(3px); }

        .log {
            margin-top: 15px;
            min-height: 54px; 
            font-size: 18px;
            color: #f39c12;
            line-height: 1.5;
        }

        /* å‹•ç•«ç‰¹æ•ˆ */
        .shake { animation: shake 0.5s; }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* çµæœç•«é¢è¨­å®š */
        .result-screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        /* å¼·åˆ¶éš±è—çš„è¨­å®š */
        .hidden { 
            display: none !important; 
        }

    </style>
</head>
<body>

<div class="game-container">
    <h1 id="game-title">âš”ï¸ æ•¸å­¸å‹‡è€…ï¼šç¬¬ä¸€é—œ âš”ï¸</h1>
    
    <div class="battle-area">
        <div style="width: 100px; text-align: center;">
            <div id="monster" class="character">ğŸ‰</div> <div class="hp-bar-container"><div id="monster-hp-bar" class="hp-bar"></div></div>
            <div>é­”ç‹ HP: <span id="monster-hp">80</span></div>
        </div>
        
        <div style="font-size: 40px; align-self: center;">VS</div>

        <div style="width: 100px; text-align: center;">
            <div id="hero" class="character">ğŸ›¡ï¸</div>
            <div class="hp-bar-container"><div id="hero-hp-bar" class="hp-bar"></div></div>
            <div>å‹‡è€… HP: <span id="hero-hp">3</span></div>
        </div>
    </div>

    <div class="log" id="game-log">æº–å‚™å¥½æˆ°é¬¥äº†å—ï¼Ÿ<br>æœ¬é—œæŒ‘æˆ°ã€Œå…ˆä¹˜é™¤å¾ŒåŠ æ¸›ã€ï¼</div>

    <div class="question-box" id="question-display">
        é¡Œç›®è¼‰å…¥ä¸­...
    </div>

    <div>
        <input type="number" id="answer-input" placeholder="?" autofocus>
        <button onclick="checkAnswer()">æ”»æ“Šï¼</button>
    </div>
</div>

<div id="result-screen" class="result-screen hidden">
    <h1 id="result-title" style="font-size: 60px;">ğŸ† å‹‡è€…å‹åˆ©ï¼</h1>
    <p id="result-msg" style="font-size: 24px; color: #ccc;">æ­å–œä½ æ‰“æ•—äº†é­”ç‹ï¼</p>
    <button onclick="nextLevelOrRestart()" id="next-button" style="background-color: #27ae60; margin-top: 20px;">é€²å…¥ä¸‹ä¸€é—œ</button>
</div>

<script>
    let monsterHP = 100; // èª¿æ•´ï¼šé­”ç‹è¡€é‡æ”¹å› 100
    const DAMAGE = 20;  // èª¿æ•´ï¼šç­”å°ä¸€é¡Œæ‰£ 20 é» (ç¢ºä¿ 5 é¡Œé€šé—œ)
    let heroHP = 3;
    let currentAnswer = 0;
    let currentLevel = 1;

    const levelSettings = {
        1: {
            title: "âš”ï¸ æ•¸å­¸å‹‡è€…ï¼šç¬¬ä¸€é—œ (åŸºç¤é‹ç®—) âš”ï¸",
            monsterEmoji: "ğŸ‰", // é¾
            intro: "æœ¬é—œæŒ‘æˆ°ã€Œå…ˆä¹˜é™¤å¾ŒåŠ æ¸›ã€ï¼",
            types: [0, 1, 2, 3], // ä¸å«æ‹¬è™Ÿ
            maxN: 30 // æ•¸å­—ç¯„åœ 5~30
        },
        2: {
            title: "ğŸ”¥ æ•¸å­¸å‹‡è€…ï¼šç¬¬äºŒé—œ (æ‹¬è™Ÿé€²éš) ğŸ”¥",
            monsterEmoji: "ğŸ˜ˆ", // æƒ¡é­”
            intro: "æœ¬é—œæŒ‘æˆ°ã€Œæ‹¬è™Ÿå„ªå…ˆã€èˆ‡å¤§æ•¸å­—ï¼",
            types: [0, 1, 2, 3, 4, 5, 6], // å«æ‹¬è™Ÿ
            maxN: 150 // æ•¸å­—ç¯„åœ 10~150
        }
    };
    
    // åˆå§‹åŒ–éŠæˆ²/é—œå¡è¨­å®š
    function initGame(level) {
        currentLevel = level;
        
        // é‡è¨­è¡€é‡
        monsterHP = 80;
        heroHP = 3;
        
        const settings = levelSettings[currentLevel];
        document.getElementById('game-title').innerText = settings.title;
        document.getElementById('monster').innerText = settings.monsterEmoji;
        document.getElementById('game-log').innerHTML = settings.intro + "<br>é–‹å§‹æˆ°é¬¥ï¼";
        document.getElementById('game-log').style.color = "#f39c12";

        document.getElementById('result-screen').classList.add('hidden');
        generateQuestion();
        updateUI();
    }

    // ç”¢ç”Ÿé¡Œç›®
    function generateQuestion() {
        const settings = levelSettings[currentLevel];
        let type = settings.types[Math.floor(Math.random() * settings.types.length)];
        let qText = "";
        let ans = 0;
        
        let minN = (currentLevel === 2) ? 10 : 5; 
        
        // æ•¸å­—ç”Ÿæˆå‡½å¼
        const genNum = (max, min = minN) => Math.floor(Math.random() * (max - min)) + min;
        
        // æ•¸å­—ç¯„åœè¨­å®š
        let n1 = genNum(settings.maxN); 
        let n2 = genNum(10); 
        let n3 = genNum(10); 

        switch(type) {
            // Level 1 & 2 å…±åŒé¡Œç›® (å…ˆä¹˜é™¤å¾ŒåŠ æ¸›)
            case 0: // A + B x C 
                qText = `${n1} + ${n2} Ã— ${n3}`;
                ans = n1 + (n2 * n3);
                break;
            case 1: // A - B x C
                let product = n2 * n3;
                let bigNum = product + genNum(settings.maxN, 10); // ç¢ºä¿èµ·å§‹æ•¸å¤ å¤§
                qText = `${bigNum} - ${n2} Ã— ${n3}`;
                ans = bigNum - product;
                break;
            case 2: // A + B / C
                let dividend = n2 * n3; 
                qText = `${n1} + ${dividend} Ã· ${n3}`;
                ans = n1 + (dividend / n3);
                break;
            case 3: // A - B / C
                let divVal = n2 * n3;
                let startNum = divVal + genNum(settings.maxN, 10);
                qText = `${startNum} - ${divVal} Ã· ${n3}`;
                ans = startNum - (divVal / n3);
                break;

            // Level 2 å°ˆå±¬é¡Œç›® (æ‹¬è™Ÿå„ªå…ˆ)
            case 4: // A x (B + C) 
                let b = genNum(settings.maxN / 2); // é¿å…æ•¸å­—çˆ†è¡¨
                let c = genNum(settings.maxN / 2);
                qText = `${n2} Ã— <span class="paren">(</span>${b} + ${c}<span class="paren">)</span>`;
                ans = n2 * (b + c);
                break;

            case 5: // A x (B - C)
                let b_sub = genNum(settings.maxN, 5); 
                let c_sub = genNum(b_sub - 3, 2); // ç¢ºä¿ B > C ä¸”å·®å€¼ > 1
                qText = `${n2} Ã— <span class="paren">(</span>${b_sub} - ${c_sub}<span class="paren">)</span>`;
                ans = n2 * (b_sub - c_sub);
                break;

            case 6: // (A + B) / C
                let sum = n1 + n2;
                let c_divisor = 0;
                // æ‰¾åˆ° sum çš„å› æ•¸ä½œç‚º C
                for (let i = 2; i <= Math.sqrt(sum); i++) {
                    if (sum % i === 0) {
                        c_divisor = i;
                        break;
                    }
                }
                if (c_divisor === 0) c_divisor = sum; 

                qText = `<span class="paren">(</span>${n1} + ${n2}<span class="paren">)</span> Ã· ${c_divisor}`;
                ans = (n1 + n2) / c_divisor;
                break;
        }

        document.getElementById('question-display').innerHTML = `${qText} = ?`;
        currentAnswer = ans;
        document.getElementById('answer-input').value = '';
        document.getElementById('answer-input').focus();
    }

    function checkAnswer() {
        let input = document.getElementById('answer-input').value;
        if (input === '') return;

        let playerAns = parseInt(input);
        let log = document.getElementById('game-log');
        let monster = document.getElementById('monster');

        if (playerAns === currentAnswer) {
            // ç­”å°
            monsterHP -= DAMAGE; 
            log.innerHTML = "âš¡ æ”»æ“ŠæˆåŠŸï¼<br>é­”ç‹å—åˆ°é‡å‚·ï¼";
            log.style.color = "#2ecc71";
            
            monster.classList.add('shake');
            setTimeout(() => monster.classList.remove('shake'), 500);

        } else {
            // ç­”éŒ¯
            heroHP -= 1;
            const hint = currentLevel === 1 ? "è¨˜å¾—ã€Œå…ˆä¹˜é™¤ï¼Œå¾ŒåŠ æ¸›ã€ï¼" : "å°å¿ƒã€Œæ‹¬è™Ÿå„ªå…ˆã€æˆ–ã€Œå…ˆä¹˜é™¤å¾ŒåŠ æ¸›ã€ï¼";
            log.innerHTML = `ğŸ’¥ å“å‘€ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ <b>${currentAnswer}</b>ã€‚<br>${hint}`;
            log.style.color = "#e74c3c";
            
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 500);
        }

        checkWinLose();
    }

    function checkWinLose() {
        updateUI();
        if (monsterHP <= 0) {
            showResult(true);
        } else if (heroHP <= 0) {
            showResult(false);
        } else {
            // æ ¹æ“šç­”å°ç­”éŒ¯å»¶é²ç”¢ç”Ÿä¸‹ä¸€é¡Œ
            let delay = (document.getElementById('game-log').style.color === "rgb(231, 76, 60)") ? 2500 : 1000;
            setTimeout(generateQuestion, delay);
        }
    }

    function updateUI() {
        document.getElementById('monster-hp').innerText = monsterHP > 0 ? monsterHP : 0;
        document.getElementById('hero-hp').innerText = heroHP;
        document.getElementById('monster-hp-bar').style.width = (monsterHP / 80 * 100) + "%";
        document.getElementById('hero-hp-bar').style.width = (heroHP / 3 * 100) + "%";
    }

    function showResult(isWin) {
        let screen = document.getElementById('result-screen');
        let title = document.getElementById('result-title');
        let msg = document.getElementById('result-msg');
        let nextButton = document.getElementById('next-button');
        
        screen.classList.remove('hidden');
        
        if (isWin) {
            if (currentLevel === 1) {
                // é€šé—œç¬¬ä¸€é—œ
                title.innerText = "â­ ç¬¬ä¸€é—œçªç ´ï¼";
                msg.innerText = "ä½ å·²æŒæ¡äº†åŸºç¤è¦å‰‡ï¼æº–å‚™æŒ‘æˆ°æ›´å¼·å¤§çš„é­”ç‹å§ï¼";
                nextButton.innerText = "é€²å…¥ç¬¬äºŒé—œ (æ‹¬è™ŸæŒ‘æˆ°)";
                nextButton.style.backgroundColor = "#e67e22"; // æ©˜è‰²
            } else {
                // é€šé—œç¬¬äºŒé—œ (éŠæˆ²å‹åˆ©)
                title.innerText = "ğŸ‰ æ­å–œï¼æœ€çµ‚å‹åˆ©ï¼";
                title.style.color = "#f1c40f";
                msg.innerText = "ä½ å·²æ˜¯æ•¸å­¸é ˜åŸŸçš„çœŸæ­£å‹‡è€…ï¼å»é ˜å–ä½ çš„å¤§çå‹µå§ï¼";
                nextButton.innerText = "é‡æ–°é–‹å§‹éŠæˆ²";
                nextButton.style.backgroundColor = "#3498db"; // è—è‰²
            }
        } else {
            // æŒ‘æˆ°å¤±æ•—
            title.innerText = "ğŸ’€ æŒ‘æˆ°å¤±æ•—...";
            title.style.color = "#e74c3c";
            msg.innerText = "åˆ¥æ°£é¤’ï¼Œå†è©¦ä¸€æ¬¡å°±èƒ½æ‰“æ•—ä»–ï¼";
            nextButton.innerText = "é‡æ–°æŒ‘æˆ°æœ¬é—œ";
            nextButton.style.backgroundColor = "#e74c3c"; // ç´…è‰²
        }
    }

    function nextLevelOrRestart() {
        if (monsterHP <= 0) {
            if (currentLevel === 1) {
                initGame(2); // é€²å…¥ç¬¬äºŒé—œ
            } else {
                initGame(1); // å¾ç¬¬ä¸€é—œé‡æ–°é–‹å§‹
            }
        } else {
            // æŒ‘æˆ°å¤±æ•—ï¼Œé‡è¨­æœ¬é—œ
            initGame(currentLevel); 
        }
    }

    // æ”¯æ´æŒ‰ Enter é€å‡º
    document.getElementById("answer-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            checkAnswer();
        }
    });

    // éŠæˆ²å•Ÿå‹•
    initGame(1);
</script>

</body>
</html>