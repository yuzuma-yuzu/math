<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸å‹‡è€…ï¼šå››å‰‡é‹ç®—å¤§æŒ‘æˆ° V4.4 (ç­”éŒ¯é¡¯ç¤ºåŸé¡Œèˆ‡æ­£è§£)</title>
    <style>
        /* CSS æ¨£å¼ç¶­æŒä¸è®Š */
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .game-container {
            background-color: #34495e;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            width: 90%;
            max-width: 600px;
            border: 4px solid #f1c40f;
            position: relative; 
            z-index: 1;
        }

        h1 { margin-top: 0; color: #f1c40f; text-shadow: 2px 2px #000; }

        /* æˆ°é¬¥å€ */
        .battle-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin: 20px 0;
            height: 150px;
        }

        .character {
            font-size: 80px;
            transition: transform 0.2s;
            cursor: default;
        }

        .hp-bar-container {
            width: 100%;
            height: 20px;
            background-color: #555;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .hp-bar {
            height: 100%;
            transition: width 0.5s ease-out;
        }

        #monster-hp-bar { background-color: #e74c3c; width: 100%; }
        #hero-hp-bar { background-color: #2ecc71; width: 100%; }

        /* é¡Œç›®å€ */
        .question-box {
            background-color: #ecf0f1;
            color: #2c3e50;
            font-size: 32px;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 3px dashed #bdc3c7;
        }
        
        /* è®“æ‹¬è™Ÿé¡Œç›®æ›´æ˜é¡¯ */
        .question-box span.paren { color: #e74c3c; }

        /* è¼¸å…¥å€ */
        input[type="number"] {
            font-size: 24px;
            padding: 10px;
            width: 120px;
            text-align: center;
            border-radius: 5px;
            border: none;
        }

        button {
            font-size: 24px;
            padding: 10px 25px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            box-shadow: 0 5px #2980b9;
            margin-left: 10px;
        }
        button:active { box-shadow: 0 2px #2980b9; transform: translateY(3px); }

        .log {
            margin-top: 15px;
            min-height: 54px; 
            font-size: 18px;
            color: #f39c12;
            line-height: 1.5;
        }

        /* å‹•ç•«ç‰¹æ•ˆ */
        .shake { animation: shake 0.5s; }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* çµæœç•«é¢è¨­å®š */
        .result-screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        /* å¼·åˆ¶éš±è—çš„è¨­å®š */
        .hidden { 
            display: none !important; 
        }

    </style>
</head>
<body>

<div class="game-container">
    <h1 id="game-title">âš”ï¸ æ•¸å­¸å‹‡è€…ï¼šç¬¬ä¸€é—œ (é«˜æ•¸å­—æŒ‘æˆ°) âš”ï¸</h1>
    
    <div class="battle-area">
        <div style="width: 100px; text-align: center;">
            <div id="monster" class="character">ğŸ‰</div> <div class="hp-bar-container"><div id="monster-hp-bar" class="hp-bar"></div></div>
            <div>é­”ç‹ HP: <span id="monster-hp">100</span></div>
        </div>
        
        <div style="font-size: 40px; align-self: center;">VS</div>

        <div style="width: 100px; text-align: center;">
            <div id="hero" class="character">ğŸ›¡ï¸</div>
            <div class="hp-bar-container"><div id="hero-hp-bar" class="hp-bar"></div></div>
            <div>å‹‡è€… HP: <span id="hero-hp">3</span></div>
        </div>
    </div>

    <div class="log" id="game-log">æº–å‚™å¥½æˆ°é¬¥äº†å—ï¼Ÿ<br>æœ¬é—œæŒ‘æˆ°ã€Œå¤§æ•¸å­—è¨ˆç®—ã€ï¼éœ€è¦ç­†ç®—å–”ï¼</div>

    <div class="question-box" id="question-display">
        é¡Œç›®è¼‰å…¥ä¸­...
    </div>

    <div>
        <input type="number" id="answer-input" placeholder="?" autofocus>
        <button onclick="checkAnswer()">æ”»æ“Šï¼</button>
    </div>
</div>

<div id="result-screen" class="result-screen hidden">
    <h1 id="result-title" style="font-size: 60px;">ğŸ† å‹‡è€…å‹åˆ©ï¼</h1>
    <p id="result-msg" style="font-size: 24px; color: #ccc;">æ­å–œä½ æ‰“æ•—äº†é­”ç‹ï¼</p>
    <button onclick="nextLevelOrRestart()" id="next-button" style="background-color: #27ae60; margin-top: 20px;">é€²å…¥ä¸‹ä¸€é—œ</button>
</div>

<script>
    // æ ¸å¿ƒæ•¸å€¼
    let monsterHP = 100; // 5 é¡Œé€šé—œ
    const DAMAGE = 20;  
    let heroHP = 3;
    let currentAnswer = 0;
    let currentLevel = 1;

    const levelSettings = {
        1: {
            title: "âš”ï¸ æ•¸å­¸å‹‡è€…ï¼šç¬¬ä¸€é—œ (é«˜æ•¸å­—æŒ‘æˆ°) âš”ï¸",
            monsterEmoji: "ğŸ‰", 
            intro: "æœ¬é—œæŒ‘æˆ°ã€Œå¤§æ•¸å­—è¨ˆç®—ã€ï¼éœ€è¦ç­†ç®—å–”ï¼",
            types: [0, 1, 2, 3, 7], // è¤‡é›œä¹˜é™¤ï¼Œç„¡æ‹¬è™Ÿ
            maxN: 300, 
            isParentheses: false 
        },
        2: {
            title: "ğŸ”¥ æ•¸å­¸å‹‡è€…ï¼šç¬¬äºŒé—œ (æ‹¬è™Ÿèˆ‡ä¹˜é™¤é€£è²«æŒ‘æˆ°) ğŸ”¥",
            monsterEmoji: "ğŸ˜ˆ", 
            intro: "æœ¬é—œæŒ‘æˆ°ã€Œæ‹¬è™Ÿå„ªå…ˆã€èˆ‡ã€Œä¹˜é™¤é€£è²«ï¼šç”±å·¦è‡³å³ã€ï¼",
            types: [4, 5, 6, 9], // 4,5,6: æ‹¬è™Ÿ, 9: ä¹˜é™¤é€£è²« (æ–°å¢)
            maxN: 150, 
            isParentheses: true 
        }
    };
    
    // åˆå§‹åŒ–éŠæˆ²/é—œå¡è¨­å®š
    function initGame(level) {
        currentLevel = level;
        
        monsterHP = 100; 
        heroHP = 3;
        
        const settings = levelSettings[currentLevel];
        document.getElementById('game-title').innerText = settings.title;
        document.getElementById('monster').innerText = settings.monsterEmoji;
        document.getElementById('game-log').innerHTML = settings.intro + "<br>é–‹å§‹æˆ°é¬¥ï¼";
        document.getElementById('game-log').style.color = "#f39c12";

        document.getElementById('result-screen').classList.add('hidden');
        generateQuestion();
        updateUI();
    }

    // æ•¸å­—ç”Ÿæˆå‡½å¼
    const genNum = (max, min = 5) => Math.floor(Math.random() * (max - min)) + min;
    const genDivisor = (max) => Math.floor(Math.random() * (max - 10)) + 10; 

    // **é‡è¦è¼”åŠ©å‡½æ•¸ï¼šæ‰¾åˆ°ä¸€å€‹æ•¸å­—çš„å› æ•¸**
    function findDivisor(number, maxDivisor) {
        let divisors = [];
        for (let i = 2; i <= Math.min(maxDivisor, number); i++) {
            if (number % i === 0) {
                divisors.push(i);
            }
        }
        if (divisors.length > 0) return divisors[Math.floor(Math.random() * divisors.length)];
        return 1;
    }

    function generateQuestion() {
        const settings = levelSettings[currentLevel];
        let type = settings.types[Math.floor(Math.random() * settings.types.length)];
        let qText = "";
        let ans = 0;
        
        // æ•¸å­—ç¯„åœèª¿æ•´
        let max_n1 = settings.maxN;
        let max_n_small = (settings.maxN > 100) ? 15 : 10; 

        let n1 = genNum(max_n1); 
        let n2 = genNum(max_n_small, 2); 
        let n3 = genNum(max_n_small, 2); 

        // é¡Œç›®ç”Ÿæˆé‚è¼¯
        switch(type) {
            // Level 1: é«˜æ•¸å­—æŒ‘æˆ° (å…ˆä¹˜é™¤å¾ŒåŠ æ¸›) - é‚è¼¯èˆ‡ V4.3 ç›¸åŒï¼Œç¢ºä¿ç„¡è² æ•¸ã€ç„¡å°æ•¸
            case 0: // A + B x C 
                let b_big = genNum(max_n_small + 5, 10); 
                qText = `${n1} + ${b_big} Ã— ${n3}`;
                ans = n1 + (b_big * n3);
                break;
            case 1: // A - B x C 
                let b_big_p = genNum(max_n_small + 5, 10);
                let product = b_big_p * n3;
                let bigNum = product + genNum(max_n1 / 2, 50); 
                qText = `${bigNum} - ${b_big_p} Ã— ${n3}`;
                ans = bigNum - product;
                break;
            case 2: // A + B / C
                let divisor = genDivisor(20); 
                let quotient = genNum(15, 5); 
                let dividend = divisor * quotient; 
                qText = `${n1} + ${dividend} Ã· ${divisor}`;
                ans = n1 + quotient;
                break;
            case 3: // A - B / C
                let divisor_m = genDivisor(20);
                let quotient_m = genNum(15, 5);
                let divVal = divisor_m * quotient_m;
                let startNum = divVal + genNum(max_n1 / 2, 50); 
                qText = `${startNum} - ${divVal} Ã· ${divisor_m}`;
                ans = startNum - quotient_m;
                break;
            case 7: // è¤‡é›œé™¤æ³• (é›™ä½æ•¸é™¤æ³•)
                let divisor_c = genDivisor(30); 
                let quotient_c = genNum(15, 5);
                let dividend_c = divisor_c * quotient_c; 
                let operation = Math.random() < 0.5 ? '+' : '-';
                
                if (operation === '+') {
                    let add_num = genNum(50);
                    qText = `${dividend_c} Ã· ${divisor_c} + ${add_num}`;
                    ans = quotient_c + add_num;
                } else {
                    let final_add_num = genNum(quotient_c - 1, 1); 
                    qText = `${dividend_c} Ã· ${divisor_c} - ${final_add_num}`;
                    ans = quotient_c - final_add_num;
                }
                break;


            // Level 2: æ‹¬è™Ÿ + ä¹˜é™¤é€£è²«æŒ‘æˆ°
            case 4: // A x (B + C) 
                qText = `${n2} Ã— <span class="paren">(</span>${genNum(80)} + ${genNum(40)}<span class="paren">)</span>`;
                ans = eval(qText.replace(/<[^>]*>/g, '').replace('Ã—', '*').replace('Ã·', '/'));
                break;

            case 5: // A x (B - C) 
                let b_sub = genNum(100, 50); 
                let c_sub = genNum(b_sub - 3, 20); 
                qText = `${n2} Ã— <span class="paren">(</span>${b_sub} - ${c_sub}<span class="paren">)</span>`;
                ans = eval(qText.replace(/<[^>]*>/g, '').replace('Ã—', '*').replace('Ã·', '/'));
                break;

            case 6: // (A + B) / C
                let a_paren = genNum(100, 50);
                let b_paren = genNum(50, 10);
                let sum_val = a_paren + b_paren;
                let c_divisor_val = findDivisor(sum_val, 20);
                
                qText = `<span class="paren">(</span>${a_paren} + ${b_paren}<span class="paren">)</span> Ã· ${c_divisor_val}`; 
                ans = sum_val / c_divisor_val; 

                if (ans % 1 !== 0) { return generateQuestion(); } // ä¿éšªæªæ–½
                break;

            case 9: // ä¹˜é™¤é€£è²« (A Ã· B Ã— C æˆ– A Ã— B Ã· C)
                let op_order = Math.random() < 0.5 ? 'DivMul' : 'MulDiv';
                let temp_result;
                
                // å˜—è©¦ç”Ÿæˆï¼Œç¢ºä¿æ¯ä¸€æ­¥éƒ½æ•´é™¤
                for (let i = 0; i < 10; i++) {
                    let numA_c = genNum(100, 20);
                    let numB_c = genNum(10, 2);
                    let numC_c = genNum(10, 2);
                    op_order = Math.random() < 0.5 ? 'DivMul' : 'MulDiv';

                    if (op_order === 'DivMul') { // A Ã· B Ã— C
                        if (numA_c % numB_c === 0) {
                            temp_result = (numA_c / numB_c) * numC_c;
                            if (temp_result % 1 === 0 && temp_result > 0) { // ç¢ºä¿æ•´æ•¸ä¸”éè² 
                                qText = `${numA_c} Ã· ${numB_c} Ã— ${numC_c}`;
                                ans = temp_result;
                                break;
                            }
                        }
                    } else { // A Ã— B Ã· C
                        temp_result = (numA_c * numB_c);
                        if (temp_result % numC_c === 0) { // ç¢ºä¿ä¹˜ç©èƒ½è¢« C æ•´é™¤
                            ans = temp_result / numC_c;
                            if (ans % 1 === 0 && ans > 0) {
                                qText = `${numA_c} Ã— ${numB_c} Ã· ${numC_c}`;
                                break;
                            }
                        }
                    }
                }
                
                if (ans === 0 || ans % 1 !== 0) { 
                    // 10æ¬¡å˜—è©¦å¤±æ•—ï¼Œé€€å›ä¸€å€‹ç°¡å–®çš„ä¹˜é™¤ç®—å¼
                    return generateQuestion(); 
                }
                break;
        }

        document.getElementById('question-display').innerHTML = `${qText} = ?`;
        currentAnswer = ans;
        document.getElementById('answer-input').value = '';
        document.getElementById('answer-input').focus();
    }

    function checkAnswer() {
        let input = document.getElementById('answer-input').value;
        if (input === '') return;

        let playerAns = parseInt(input);
        let log = document.getElementById('game-log');
        let monster = document.getElementById('monster');

        if (playerAns === currentAnswer) {
            // ç­”å°
            monsterHP -= DAMAGE; 
            log.innerHTML = "âš¡ æ”»æ“ŠæˆåŠŸï¼<br>é­”ç‹å—åˆ°é‡å‚·ï¼";
            log.style.color = "#2ecc71";
            
            monster.classList.add('shake');
            setTimeout(() => monster.classList.remove('shake'), 500);

        } else {
            // ç­”éŒ¯ - é¡¯ç¤ºåŸé¡Œç›®å’Œæ­£ç¢ºç­”æ¡ˆ
            heroHP -= 1;
            
            // 1. å–å¾—ä¸¦æ¸…ç†é¡Œç›®æ–‡å­— (ç§»é™¤ HTML æ¨™ç±¤ï¼Œä¾‹å¦‚ <span class="paren">)
            let currentQuestionHTML = document.getElementById('question-display').innerHTML;
            let currentQuestionText = currentQuestionHTML.replace(' = ?', '').replace(/<[^>]*>/g, '');

            const hint = currentLevel === 1 ? "è¨˜å¾—ã€Œå…ˆä¹˜é™¤å¾ŒåŠ æ¸›ã€ï¼è«‹ç­†ç®—ç¢ºèªå–”ï¼" : "å°å¿ƒã€Œæ‹¬è™Ÿå„ªå…ˆã€æˆ–ã€ŒåŒç´šé‹ç®—ï¼šç”±å·¦è‡³å³ã€çš„é †åºï¼";
            
            log.innerHTML = `ğŸ’¥ å“å‘€ï¼ä½ å›ç­” ${playerAns}ï¼Œä½†æ­£ç¢ºç­”æ¡ˆæ˜¯ <b>${currentQuestionText} = ${currentAnswer}</b>ã€‚<br>${hint}`;
            log.style.color = "#e74c3c";
            
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 500);
        }

        checkWinLose();
    }

    function checkWinLose() {
        updateUI();
        if (monsterHP <= 0) {
            showResult(true);
        } else if (heroHP <= 0) {
            showResult(false);
        } else {
            // æ ¹æ“šç­”å°ç­”éŒ¯å»¶é²ç”¢ç”Ÿä¸‹ä¸€é¡Œ
            let delay = (document.getElementById('game-log').style.color === "rgb(231, 76, 60)") ? 3000 : 1000; 
            setTimeout(generateQuestion, delay);
        }
    }

    function updateUI() {
        document.getElementById('monster-hp').innerText = monsterHP > 0 ? monsterHP : 0;
        document.getElementById('hero-hp').innerText = heroHP;
        
        document.getElementById('monster-hp-bar').style.width = (monsterHP / 100 * 100) + "%";
        document.getElementById('hero-hp-bar').style.width = (heroHP / 3 * 100) + "%";
    }

    function showResult(isWin) {
        let screen = document.getElementById('result-screen');
        let title = document.getElementById('result-title');
        let msg = document.getElementById('result-msg');
        let nextButton = document.getElementById('next-button');
        
        screen.classList.remove('hidden');
        
        if (isWin) {
            if (currentLevel === 1) {
                // é€šé—œç¬¬ä¸€é—œ
                title.innerText = "â­ ç¬¬ä¸€é—œçªç ´ï¼ (5/5 é¡Œ)";
                msg.innerText = "æˆåŠŸå¾æœå¤§æ•¸å­—ï¼æº–å‚™æŒ‘æˆ°é€£è²«é‹ç®—å’Œæ‹¬è™Ÿå§ï¼";
                nextButton.innerText = "é€²å…¥ç¬¬äºŒé—œ (æœ€çµ‚æŒ‘æˆ°)";
                nextButton.style.backgroundColor = "#e67e22"; 
            } else {
                // é€šé—œç¬¬äºŒé—œ (éŠæˆ²å‹åˆ©)
                title.innerText = "ğŸ‰ æ­å–œï¼æœ€çµ‚å‹åˆ©ï¼ (5/5 é¡Œ)";
                title.style.color = "#f1c40f";
                msg.innerText = "ä½ å·²æ˜¯æ•¸å­¸é ˜åŸŸçš„çœŸæ­£å‹‡è€…ï¼å»é ˜å–ä½ çš„å¤§çå‹µå§ï¼";
                nextButton.innerText = "é‡æ–°é–‹å§‹éŠæˆ²";
                nextButton.style.backgroundColor = "#3498db"; 
            }
        } else {
            // æŒ‘æˆ°å¤±æ•—
            title.innerText = "ğŸ’€ æŒ‘æˆ°å¤±æ•—...";
            title.style.color = "#e74c3c";
            msg.innerText = "åˆ¥æ°£é¤’ï¼Œå†è©¦ä¸€æ¬¡å°±èƒ½æ‰“æ•—ä»–ï¼";
            nextButton.innerText = "é‡æ–°æŒ‘æˆ°æœ¬é—œ";
            nextButton.style.backgroundColor = "#e74c3c"; 
        }
    }

    function nextLevelOrRestart() {
        if (monsterHP <= 0) {
            if (currentLevel === 1) {
                initGame(2); // é€²å…¥ç¬¬äºŒé—œ
            } else {
                initGame(1); // å¾ç¬¬ä¸€é—œé‡æ–°é–‹å§‹
            }
        } else {
            // æŒ‘æˆ°å¤±æ•—ï¼Œé‡è¨­æœ¬é—œ
            initGame(currentLevel); 
        }
    }

    // æ”¯æ´æŒ‰ Enter é€å‡º
    document.getElementById("answer-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            checkAnswer();
        }
    });

    // éŠæˆ²å•Ÿå‹•
    initGame(1);
</script>

</body>
</html>